name: Auto Sync Longhua Assets

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨3ç‚¹æ‰§è¡Œï¼ˆUTC æ—¶é—´ 19:00 = åŒ—äº¬æ—¶é—´ 03:00ï¼‰
    - cron: '0 19 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'cloud_sync.py'

env:
  PYTHON_VERSION: '3.9'
  CLASH_VERSION: 'v1.18.9'

jobs:
  sync-longhua:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout Code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq wget curl unzip
          python -m pip install --upgrade pip
          pip install requests==2.31.0 selenium==4.9.1

      - name: âš™ï¸ Setup Mihomo Proxy (Auto Port Selection)
        run: |
          echo "=== [é˜¶æ®µ1] ä¸‹è½½ Mihomo æ ¸å¿ƒ ==="
          wget -q https://github.com/MetaCubeX/Mihomo/releases/download/v${{ env.CLASH_VERSION }}/mihomo-linux-amd64-v${{ env.CLASH_VERSION }}.gz || wget -q https://github.com/MetaCubeX/Mihomo/releases/latest/download/mihomo-linux-amd64.gz
          gunzip -f mihomo-linux-amd64*.gz || true
          mv mihomo-linux-amd64* mihomo
          chmod +x mihomo

          echo "=== [é˜¶æ®µ2] è‡ªåŠ¨é€‰æ‹©å¯ç”¨ç«¯å£ ==="
          for PORT in $(seq 17001 17010); do
            cat <<EOF > config.yaml
mixed-port: 7890
allow-lan: true
mode: global
log-level: info
proxies:
  - name: "TW-${PORT}"
    type: ss
    server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
    port: ${PORT}
    cipher: aes-256-gcm
    password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
    udp: false
EOF

            nohup ./mihomo -f config.yaml > mihomo.log 2>&1 &
            sleep 15
            IP=$(curl -s --max-time 10 -x http://127.0.0.1:7890 https://ifconfig.me || echo "fail")
            if [[ "$IP" != "fail" && "$IP" != 20.* && "$IP" != 52.* ]]; then
              echo "âœ… å·²æˆåŠŸè¿æ¥ä»£ç†èŠ‚ç‚¹: $IP (ç«¯å£ $PORT)"
              echo "USE_PROXY=true" >> $GITHUB_ENV
              break
            else
              echo "âŒ ç«¯å£ $PORT ä¸é€šï¼Œé‡è¯•ä¸‹ä¸€ä¸ª..."
              pkill -f mihomo || true
              sleep 3
            fi
          done

          if [[ -z "$USE_PROXY" ]]; then
            echo "âš ï¸ æ— æ³•å»ºç«‹ä»£ç†è¿æ¥ï¼Œè¿›å…¥ç›´è¿æ¨¡å¼"
            echo "USE_PROXY=false" >> $GITHUB_ENV
          fi

      - name: ğŸ”„ Run Sync Script
        run: |
          echo "=== [é˜¶æ®µ3] å¯åŠ¨åŒæ­¥è„šæœ¬ ==="

          if [[ "$USE_PROXY" == "true" ]]; then
            export http_proxy="http://127.0.0.1:7890"
            export https_proxy="http://127.0.0.1:7890"
            echo "âœ… ä»£ç†æ¨¡å¼å¯ç”¨ä¸­..."
          else
            echo "âš ï¸ å½“å‰ä¸ºç›´è¿æ¨¡å¼è¿è¡Œï¼Œå¯èƒ½æ— æ³•è®¿é—®å°æ¹¾èµ„æº"
          fi

          echo "å¼€å§‹æ‰§è¡Œ cloud_sync.py ..."
          python cloud_sync.py || echo "âŒ è„šæœ¬æ‰§è¡Œå¼‚å¸¸"

      - name: ğŸ“¤ Commit & Push Updates
        if: always()
        run: |
          echo "=== [é˜¶æ®µ4] æäº¤å˜æ›´ ==="
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [[ -n "$(git status --porcelain)" ]]; then
            git add .
            git commit -m "ğŸ”„ Auto Sync Longhua Assets ($(date +'%Y-%m-%d %H:%M:%S'))"
            git push
            echo "âœ… æ›´æ–°å·²æäº¤"
          else
            echo "ğŸ“­ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          fi

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "=== [é˜¶æ®µ5] æ¸…ç†è¿›ç¨‹ä¸ä¸´æ—¶æ–‡ä»¶ ==="
          pkill -f mihomo || true
          rm -f mihomo config.yaml mihomo.log || true
          echo "âœ… æ¸…ç†å®Œæˆ"
