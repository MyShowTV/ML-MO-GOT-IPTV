name: Auto Sync Longhua Assets

on:
  schedule:
    - cron: '0 19 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨3ç‚¹
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'cloud_sync.py'

env:
  PYTHON_VERSION: '3.9'

jobs:
  sync-longhua:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ§© Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq wget curl unzip
          pip install --upgrade pip
          pip install selenium==4.9.1 requests==2.31.0

      - name: ğŸš€ Setup V2Ray Proxy
        run: |
          echo "è®¾ç½® V2Ray ä»£ç†..."
          echo "æ­£åœ¨ä¸‹è½½ V2Ray æ ¸å¿ƒ..."
          
          # ä¸‹è½½ V2Ray
          V2RAY_URL="https://github.com/v2fly/v2ray-core/releases/download/v5.16.1/v2ray-linux-64.zip"
          echo "ä¸‹è½½ V2Ray: $V2RAY_URL"
          
          wget -q "$V2RAY_URL" -O v2ray.zip
          if [ $? -eq 0 ]; then
            echo "âœ… V2Ray ä¸‹è½½æˆåŠŸ"
            unzip -q v2ray.zip v2ray v2ctl -d .
            chmod +x v2ray v2ctl
            rm v2ray.zip
          else
            echo "âŒ V2Ray ä¸‹è½½å¤±è´¥ï¼Œè·³è¿‡ä»£ç†è®¾ç½®"
            echo "NO_PROXY=true" >> $GITHUB_ENV
            exit 0
          fi
          
          # åˆ›å»º V2Ray é…ç½®æ–‡ä»¶
          echo "åˆ›å»º V2Ray é…ç½®æ–‡ä»¶..."
          cat > config.json << 'CONFIG_EOF'
          {
            "inbounds": [
              {
                "port": 10808,
                "protocol": "socks",
                "settings": {
                  "auth": "noauth",
                  "udp": false
                },
                "listen": "127.0.0.1"
              }
            ],
            "outbounds": [
              {
                "protocol": "shadowsocks",
                "settings": {
                  "servers": [
                    {
                      "address": "brtlee3ogRTfxtWt.xf9pzeslxw.sbs",
                      "port": 17001,
                      "method": "aes-256-gcm",
                      "password": "1d23e3c5-c047-46a0-b7d8-d838aff7ae8d"
                    },
                    {
                      "address": "brtlee3ogRTfxtWt.xf9pzeslxw.sbs",
                      "port": 17002,
                      "method": "aes-256-gcm",
                      "password": "1d23e3c5-c047-46a0-b7d8-d838aff7ae8d"
                    },
                    {
                      "address": "brtlee3ogRTfxtWt.xf9pzeslxw.sbs",
                      "port": 17003,
                      "method": "aes-256-gcm",
                      "password": "1d23e3c5-c047-46a0-b7d8-d838aff7ae8d"
                    }
                  ]
                }
              }
            ],
            "routing": {
              "domainStrategy": "AsIs",
              "rules": []
            }
          }
          CONFIG_EOF
          
          # å¯åŠ¨ V2Ray
          echo "å¯åŠ¨ V2Ray ä»£ç†..."
          ./v2ray -config config.json > v2ray.log 2>&1 &
          V2RAY_PID=$!
          echo "V2RAY_PID=$V2RAY_PID" >> $GITHUB_ENV
          sleep 8
          
          # æµ‹è¯•ä»£ç†è¿æ¥
          echo "æµ‹è¯•ä»£ç†è¿æ¥..."
          PROXY_SUCCESS=false
          for i in {1..5}; do
            echo "å°è¯• $i/5..."
            RESPONSE=$(curl -s --max-time 10 --socks5-hostname 127.0.0.1:10808 "http://ip-api.com/json/?fields=countryCode,query" || echo '{"countryCode":"ERROR"}')
            COUNTRY=$(echo $RESPONSE | jq -r '.countryCode' 2>/dev/null || echo "ERROR")
            
            if [[ "$COUNTRY" == "TW" ]]; then
              IP=$(echo $RESPONSE | jq -r '.query')
              echo "âœ… ä»£ç†è¿æ¥æˆåŠŸ | IP: $IP | å›½å®¶: å°æ¹¾"
              PROXY_SUCCESS=true
              echo "PROXY_SUCCESS=true" >> $GITHUB_ENV
              break
            elif [[ "$COUNTRY" != "ERROR" ]]; then
              echo "å½“å‰ IP å›½å®¶: $COUNTRY"
            fi
            sleep 2
          done
          
          if [ "$PROXY_SUCCESS" = false ]; then
            echo "âš ï¸ ä»£ç†è¿æ¥æµ‹è¯•æœªé€šè¿‡å°æ¹¾ IP"
            echo "PROXY_SUCCESS=false" >> $GITHUB_ENV
          fi

      - name: ğŸ”„ Run Sync Script
        run: |
          echo "è®¾ç½®ä»£ç†ç¯å¢ƒ..."
          
          # æ£€æŸ¥ä»£ç†æ˜¯å¦å¯ç”¨
          if [ -n "$V2RAY_PID" ] && [ "$PROXY_SUCCESS" = "true" ]; then
            export http_proxy="socks5://127.0.0.1:10808"
            export https_proxy="socks5://127.0.0.1:10808"
            export HTTP_PROXY="socks5://127.0.0.1:10808"
            export HTTPS_PROXY="socks5://127.0.0.1:10808"
            echo "ä½¿ç”¨ SOCKS5 ä»£ç†: socks5://127.0.0.1:10808"
            
            # éªŒè¯ä»£ç†è¿æ¥
            echo "éªŒè¯ç½‘ç»œç¯å¢ƒ..."
            RESPONSE=$(curl -s --socks5-hostname 127.0.0.1:10808 http://ip-api.com/json/ || echo '{"status":"fail"}')
            echo "å½“å‰ç½‘ç»œ: $RESPONSE"
          else
            echo "âš ï¸ æ— ä»£ç†æ¨¡å¼è¿è¡Œ"
            echo "æ³¨æ„ï¼šå¯èƒ½éœ€è¦å°æ¹¾ IP æ‰èƒ½è®¿é—®é¾™åç½‘ç«™"
          fi
          
          echo "å¼€å§‹æ‰§è¡ŒåŒæ­¥è„šæœ¬..."
          python cloud_sync.py
          
          SYNC_EXIT_CODE=$?
          if [[ $SYNC_EXIT_CODE -eq 0 ]]; then
            echo "âœ… åŒæ­¥è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ åŒæ­¥è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $SYNC_EXIT_CODE"
            # ä¸ç«‹å³é€€å‡ºï¼Œå°è¯•å®Œæˆåç»­æ­¥éª¤
          fi

      - name: ğŸ“¤ Commit Updates
        if: always()
        run: |
          echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ JSON ç»“æœæ–‡ä»¶
          if ls longhua_assets_*.json 1> /dev/null 2>&1; then
            echo "å‘ç°æ–°çš„ AssetID æ–‡ä»¶"
            git add longhua_assets_*.json
          fi
          
          # æ£€æŸ¥ workers.js æ˜¯å¦è¢«æ›´æ–°
          if [[ -f "workers.js" ]] && [[ -n $(git diff --name-only HEAD workers.js 2>/dev/null || echo "") ]]; then
            echo "workers.js å·²è¢«æ›´æ–°"
            git add workers.js
          fi
          
          # æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
          if [[ -f "sync.log" ]]; then
            echo "æ·»åŠ åŒæ­¥æ—¥å¿—"
            git add sync.log
          fi
          
          if [[ -n $(git status --porcelain) ]]; then
            git commit -m "ğŸ”„ Auto Sync Longhua Assets [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push
            echo "ğŸ“¤ å·²æäº¤æ›´æ–°"
          else
            echo "ğŸ“­ æ²¡æœ‰éœ€è¦æ›´æ–°çš„å†…å®¹"
          fi

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "æ¸…ç†è¿›ç¨‹..."
          # åœæ­¢ V2Ray è¿›ç¨‹
          if [ -n "$V2RAY_PID" ]; then
            echo "åœæ­¢ V2Ray è¿›ç¨‹: $V2RAY_PID"
            kill $V2RAY_PID 2>/dev/null || true
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f v2ray v2ctl config.json v2ray.log 2>/dev/null || true
          
          echo "å·¥ä½œæµæ‰§è¡Œå®Œæˆ"

      - name: ğŸ“Š Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ github.run_id }}
          path: |
            v2ray.log
            sync.log
          retention-days: 3
