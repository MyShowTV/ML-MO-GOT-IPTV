name: Auto Sync Longhua Assets

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨ 3 ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰
    - cron: '0 19 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'cloud_sync.py'

env:
  PYTHON_VERSION: '3.9'

jobs:
  sync-longhua:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq curl wget unzip
          python -m pip install --upgrade pip
          pip install requests==2.31.0 selenium==4.9.1 selenium-wire==5.1.0 chromedriver-autoinstaller==0.6.3

      - name: ğŸš€ Setup Proxy (Mihomo / Clash)
        run: |
          echo "=== [é˜¶æ®µ1] ä¸‹è½½ Mihomo å†…æ ¸ ==="
          set -e
          if wget -q https://github.com/MetaCubeX/mihomo/releases/download/v1.18.9/mihomo-linux-amd64-v1.18.9.gz; then
            gunzip -f mihomo-linux-amd64-v1.18.9.gz
            mv mihomo-linux-amd64-v1.18.9 clash
            chmod +x clash
            echo "âœ… å·²ä½¿ç”¨ Mihomo å†…æ ¸"
          else
            echo "âš ï¸ ä¸‹è½½ Mihomo å¤±è´¥ï¼Œå°è¯• Clash å®˜æ–¹å†…æ ¸..."
            wget -q https://github.com/Dreamacro/clash/releases/latest/download/clash-linux-amd64-v3.gz
            gunzip -f clash-linux-amd64-v3.gz
            mv clash-linux-amd64-v3 clash
            chmod +x clash
            echo "âœ… å·²ä½¿ç”¨ Clash å®˜æ–¹å†…æ ¸"
          fi

          echo "=== [é˜¶æ®µ2] åˆ›å»ºä»£ç†é…ç½®æ–‡ä»¶ ==="
          cat > clash_config.yaml <<'EOF'
          mixed-port: 7890
          allow-lan: false
          mode: global
          log-level: info
          proxies:
            - name: "TW-01"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17001
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
            - name: "TW-02"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17002
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
            - name: "TW-03"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17003
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d

          proxy-groups:
            - name: "PROXY"
              type: select
              proxies:
                - TW-01
                - TW-02
                - TW-03
          rules:
            - MATCH,PROXY
          EOF

          echo "=== [é˜¶æ®µ3] å¯åŠ¨ Mihomo/Clash ==="
          nohup ./clash -f clash_config.yaml > clash.log 2>&1 &
          sleep 15

          echo "=== [é˜¶æ®µ4] æµ‹è¯•å‡ºå£ IP ==="
          PROXY_OK=false
          for i in {1..6}; do
            echo "ğŸŒ ç¬¬ $i æ¬¡æ£€æµ‹..."
            RES=$(curl -s --max-time 10 -x http://127.0.0.1:7890 "http://ip-api.com/json/?fields=countryCode,query,status" || echo '{"status":"fail"}')
            STATUS=$(echo "$RES" | jq -r '.status')
            COUNTRY=$(echo "$RES" | jq -r '.countryCode')
            IP=$(echo "$RES" | jq -r '.query')

            if [[ "$STATUS" == "success" && "$COUNTRY" == "TW" ]]; then
              echo "âœ… ä»£ç†è¿æ¥æˆåŠŸï¼Œå‡ºå£å°æ¹¾ IP: $IP"
              PROXY_OK=true
              echo "PROXY_SUCCESS=true" >> $GITHUB_ENV
              break
            else
              echo "âŒ è¿æ¥å¤±è´¥ï¼ˆè¿”å›: $RESï¼‰"
            fi
            sleep 5
          done

          if [ "$PROXY_OK" = false ]; then
            echo "âš ï¸ ä»£ç†éªŒè¯æœªé€šè¿‡ï¼Œè¿›å…¥ç›´è¿æ¨¡å¼"
            echo "PROXY_SUCCESS=false" >> $GITHUB_ENV
          fi

      - name: ğŸ”„ Run Sync Script
        run: |
          echo "=== [é˜¶æ®µ5] å¯åŠ¨åŒæ­¥è„šæœ¬ ==="
          
          # é…ç½®ä»£ç†ç¯å¢ƒå˜é‡
          if [[ "$PROXY_SUCCESS" == "true" ]]; then
            export http_proxy="http://127.0.0.1:7890"
            export https_proxy="http://127.0.0.1:7890"
            export HTTP_PROXY="http://127.0.0.1:7890"
            export HTTPS_PROXY="http://127.0.0.1:7890"
            echo "ğŸŒ å½“å‰ä½¿ç”¨ä»£ç†æ¨¡å¼è¿è¡Œ"
            
            # è¯¦ç»†æµ‹è¯•ç›®æ ‡ç½‘ç«™è¿æ¥ï¼ˆå¸¦è¶…æ—¶å’Œé‡è¯•ï¼‰
            echo "æµ‹è¯•é¾™åç½‘ç«™è¿æ¥æ€§..."
            TARGET_URL="https://www.ofiii.com/"
            CONNECT_OK=false
            
            for attempt in {1..3}; do
              echo "å°è¯• $attempt/3..."
              
              # ä½¿ç”¨curlç›´æ¥è·å–çŠ¶æ€ç å’Œæ£€æŸ¥ç½‘ç»œè¿æ¥
              HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}\n" --max-time 15 --proxy http://127.0.0.1:7890 "$TARGET_URL")
              CURL_EXIT=$?
              
              if [[ $CURL_EXIT -eq 0 ]]; then
                echo "âœ… è¿æ¥æˆåŠŸï¼ŒHTTPçŠ¶æ€ç : $HTTP_CODE"
                
                # æ£€æŸ¥æ˜¯å¦æ˜¯è¢«æ¥å—çš„å“åº”ç 
                if [[ "$HTTP_CODE" =~ ^(200|301|302|304|307|403)$ ]]; then
                  echo "âœ… ç½‘ç«™å¯è®¿é—® (çŠ¶æ€ç : $HTTP_CODE)"
                  CONNECT_OK=true
                  break
                else
                  echo "âš ï¸ éå¸¸è§çŠ¶æ€ç : $HTTP_CODE (ä½†è¿æ¥å·²å»ºç«‹)"
                  CONNECT_OK=true
                  break
                fi
              else
                echo "âŒ è¿æ¥å¤±è´¥ (curlé€€å‡ºç : $CURL_EXIT)"
                
                # æ ¹æ®curlé€€å‡ºç ç»™å‡ºæç¤º
                case $CURL_EXIT in
                  6)  echo "   é”™è¯¯: æ— æ³•è§£æä¸»æœº" ;;
                  7)  echo "   é”™è¯¯: æ— æ³•è¿æ¥åˆ°ä¸»æœº" ;;
                  28) echo "   é”™è¯¯: æ“ä½œè¶…æ—¶" ;;
                  *)  echo "   é”™è¯¯: curlé”™è¯¯ç  $CURL_EXIT" ;;
                esac
              fi
              
              if [[ $attempt -lt 3 ]]; then
                echo "ç­‰å¾…3ç§’åé‡è¯•..."
                sleep 3
              fi
            done
            
            if [[ "$CONNECT_OK" == false ]]; then
              echo "âš ï¸ è­¦å‘Š: ç›®æ ‡ç½‘ç«™è¿æ¥æµ‹è¯•å¤±è´¥ï¼Œä½†ä»å°è¯•æ‰§è¡ŒåŒæ­¥è„šæœ¬"
              echo "å¯èƒ½åŸå› :"
              echo "  1. ç›®æ ‡ç½‘ç«™æš‚æ—¶ä¸å¯ç”¨"
              echo "  2. ä»£ç†èŠ‚ç‚¹IPè¢«é™åˆ¶"
              echo "  3. ç½‘ç»œè¶…æ—¶"
            fi
          else
            echo "âš ï¸ å½“å‰ä¸ºç›´è¿æ¨¡å¼è¿è¡Œï¼Œå¯èƒ½æ— æ³•è®¿é—®å°æ¹¾èµ„æº"
            
            # ç›´è¿æ¨¡å¼ä¹Ÿæµ‹è¯•è¿æ¥
            HTTP_CODE=$(curl -o /dev/null -s -w "%{http_code}\n" --max-time 10 "https://www.ofiii.com/")
            if [[ $? -eq 0 ]]; then
              echo "âœ… ç›´è¿æˆåŠŸï¼ŒHTTPçŠ¶æ€ç : $HTTP_CODE"
            else
              echo "âŒ ç›´è¿å¤±è´¥"
            fi
          fi
          
          echo "å¼€å§‹æ‰§è¡Œ cloud_sync.py ..."
          
          # æ·»åŠ è¶…æ—¶ä¿æŠ¤ï¼Œæœ€é•¿è¿è¡Œ10åˆ†é’Ÿ
          timeout 600 python cloud_sync.py
          SYNC_EXIT_CODE=$?
          
          if [[ $SYNC_EXIT_CODE -eq 0 ]]; then
            echo "âœ… åŒæ­¥ä»»åŠ¡å®Œæˆ"
          elif [[ $SYNC_EXIT_CODE -eq 124 ]]; then
            echo "âŒ åŒæ­¥è„šæœ¬æ‰§è¡Œè¶…æ—¶ (10åˆ†é’Ÿ)"
            exit 1
          else
            echo "âŒ cloud_sync.py æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $SYNC_EXIT_CODE"
            
            # æ˜¾ç¤ºé”™è¯¯æ—¥å¿—å°¾éƒ¨
            if [[ -f "sync.log" ]]; then
              echo "=== åŒæ­¥æ—¥å¿—å°¾éƒ¨ (æœ€å50è¡Œ) ==="
              tail -50 sync.log
              echo "=== ç»“æŸ ==="
            fi
            
            exit 1
          fi

      - name: ğŸ“¤ Commit Updates
        if: success()
        run: |
          echo "=== [é˜¶æ®µ6] æ£€æŸ¥æ–‡ä»¶å˜æ›´ ==="
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          HAS_CHANGES=false

          if ls longhua_assets_*.json 1>/dev/null 2>&1; then
            LATEST_JSON=$(ls -t longhua_assets_*.json | head -1)
            git add "$LATEST_JSON"
            HAS_CHANGES=true
          fi

          if [[ -f "workers.js" ]]; then
            git add workers.js
            HAS_CHANGES=true
          fi

          if [ "$HAS_CHANGES" = true ]; then
            git commit -m "ğŸ”„ Auto Sync Longhua Assets [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push
            echo "âœ… æ›´æ–°å·²æäº¤"
          else
            echo "ğŸ“­ æ— éœ€æäº¤æ›´æ–°"
          fi

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "=== [é˜¶æ®µ7] æ¸…ç†è¿›ç¨‹ä¸ä¸´æ—¶æ–‡ä»¶ ==="
          pkill -f clash || true
          rm -f clash clash_config.yaml clash.log *.tmp *.bak *.gz || true
          echo "âœ… æ¸…ç†å®Œæˆ"

      - name: ğŸ“Š Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ github.run_id }}
          path: |
            clash.log
            sync.log
          retention-days: 3
