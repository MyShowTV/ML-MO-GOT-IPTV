name: Auto Sync Longhua Assets

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨3ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 19 * * *'  # åŒ—äº¬æ—¶é—´ç¬¬äºŒå¤©å‡Œæ™¨3ç‚¹
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'cloud_sync.py'

env:
  PYTHON_VERSION: '3.9'
  CLASH_VERSION: 'v1.18.0'

jobs:
  sync-longhua:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ§© Checkout Code
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq wget curl unzip
          pip install --upgrade pip
          pip install selenium==4.9.1 requests==2.31.0

      - name: ğŸš€ Setup Clash Proxy
        run: |
          # ä¸‹è½½ Clash
          wget -q "https://github.com/Dreamacro/clash/releases/download/${CLASH_VERSION}/clash-linux-amd64-${CLASH_VERSION}.gz"
          gunzip "clash-linux-amd64-${CLASH_VERSION}.gz"
          mv "clash-linux-amd64-${CLASH_VERSION}" clash
          chmod +x clash
          
          # åˆ›å»ºä»£ç†é…ç½®æ–‡ä»¶ï¼ˆå°æ¹¾èŠ‚ç‚¹ï¼‰
          cat > clash_config.yaml <<'EOF'
          mixed-port: 7890
          allow-lan: false
          mode: global
          log-level: info
          
          proxies:
            - name: "TW-01"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17001
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
            
            - name: "TW-02"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17002
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
            
            - name: "TW-03"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17003
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
          
          proxy-groups:
            - name: "PROXY"
              type: select
              proxies:
                - TW-01
                - TW-02
                - TW-03
          
          rules:
            - MATCH,PROXY
          EOF
          
          # å¯åŠ¨ Clash
          ./clash -f clash_config.yaml > clash.log 2>&1 &
          CLASH_PID=$!
          sleep 10
          
          # éªŒè¯ä»£ç†è¿æ¥
          echo "æµ‹è¯•ä»£ç†è¿æ¥..."
          for i in {1..3}; do
            RESPONSE=$(curl -s --max-time 10 -x http://127.0.0.1:7890 "http://ip-api.com/json/?fields=countryCode,query" || echo '{"countryCode":"ERROR"}')
            COUNTRY=$(echo $RESPONSE | jq -r '.countryCode' 2>/dev/null || echo "ERROR")
            
            if [[ "$COUNTRY" == "TW" ]]; then
              IP=$(echo $RESPONSE | jq -r '.query')
              echo "âœ… ä»£ç†è¿æ¥æˆåŠŸ | IP: $IP | å›½å®¶: å°æ¹¾"
              echo "PROXY_SUCCESS=true" >> $GITHUB_ENV
              break
            else
              echo "å°è¯• $i: ä»£ç†è¿æ¥å¤±è´¥ ($COUNTRY)"
              sleep 2
            fi
          done
          
          if [[ "$PROXY_SUCCESS" != "true" ]]; then
            echo "âŒ ä»£ç†è¿æ¥å¤±è´¥"
            kill $CLASH_PID 2>/dev/null || true
            exit 1
          fi

      - name: ğŸ”„ Run Sync Script
        env:
          HTTP_PROXY: "http://127.0.0.1:7890"
          HTTPS_PROXY: "http://127.0.0.1:7890"
        run: |
          echo "è®¾ç½®ä»£ç†ç¯å¢ƒ..."
          export http_proxy="http://127.0.0.1:7890"
          export https_proxy="http://127.0.0.1:7890"
          
          echo "éªŒè¯ç½‘ç»œç¯å¢ƒ..."
          curl -s http://ip-api.com/json/ | jq '.countryCode + " - " + .query'
          
          echo "å¼€å§‹æ‰§è¡ŒåŒæ­¥è„šæœ¬..."
          python cloud_sync.py
          
          if [[ $? -eq 0 ]]; then
            echo "âœ… åŒæ­¥è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ åŒæ­¥è„šæœ¬æ‰§è¡Œå¤±è´¥"
            exit 1
          fi

      - name: ğŸ“¤ Commit Updates
        if: success()
        run: |
          echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ JSON ç»“æœæ–‡ä»¶
          if ls longhua_assets_*.json 1> /dev/null 2>&1; then
            echo "å‘ç°æ–°çš„ AssetID æ–‡ä»¶"
            git add longhua_assets_*.json
          fi
          
          # æ£€æŸ¥ workers.js æ˜¯å¦è¢«æ›´æ–°
          if [[ -n $(git diff --name-only HEAD workers.js 2>/dev/null) ]]; then
            echo "workers.js å·²è¢«æ›´æ–°"
            git add workers.js
          fi
          
          if [[ -n $(git status --porcelain) ]]; then
            git commit -m "ğŸ”„ Auto Sync Longhua Assets [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push
            echo "ğŸ“¤ å·²æäº¤æ›´æ–°"
          else
            echo "ğŸ“­ æ²¡æœ‰éœ€è¦æ›´æ–°çš„å†…å®¹"
          fi

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "æ¸…ç†è¿›ç¨‹..."
          pkill -f clash 2>/dev/null || true
          
          echo "å·¥ä½œæµæ‰§è¡Œå®Œæˆ"

      - name: ğŸ“Š Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: error-logs
          path: |
            clash.log
            sync.log
          retention-days: 3
