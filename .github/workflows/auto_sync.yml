name: è‡ªåŠ¨åŒæ­¥ AssetID

on:
  schedule:
    - cron: '0 0,12 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install selenium webdriver-manager
          sudo apt-get update
          sudo apt-get install -y shadowsocks-libev

      - name: å¯åŠ¨ Shadowsocks ä»£ç†
        run: |
          # -------------------------------------------------------------
          # ğŸ”´ å…³é”®ä¿®æ”¹ï¼šå°è¯•å°†åŠ å¯†æ–¹å¼æ”¹ä¸º chacha20-ietf-poly1305
          # å¦‚æœä½ çš„æœåŠ¡å™¨çœŸçš„æ˜¯ aes-256-gcmï¼Œè¯·æ”¹å› aes-256-gcm
          # -------------------------------------------------------------
          ss-local -s 154.223.20.190 -p 8388 -k "${{ secrets.SS_PASSWORD }}" -m chacha20-ietf-poly1305 -l 10808 -v &
          
          echo "ç­‰å¾…ä»£ç†å¯åŠ¨..."
          sleep 3
          
          echo "æµ‹è¯•è¿æ¥..."
          for i in {1..5}; do
            # ä½¿ç”¨ -v æŸ¥çœ‹è¯¦ç»†æ¡æ‰‹è¿‡ç¨‹
            if curl -v -x socks5://127.0.0.1:10808 -I https://www.google.com --connect-timeout 5; then
              echo "âœ… ä»£ç†è¿æ¥æˆåŠŸï¼"
              exit 0
            fi
            sleep 3
          done
          echo "âš ï¸ ä»£ç†ä¾ç„¶ä¸é€šï¼Œè¯·æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™ç«¯å£ 8388 æ˜¯å¦å¼€æ”¾ (TCP/UDP)"

      - name: è¿è¡ŒåŒæ­¥è„šæœ¬
        env:
          HTTPS_PROXY: http://127.0.0.1:10808
          HTTP_PROXY: http://127.0.0.1:10808
          NO_PROXY: localhost,127.0.0.1
        run: python cloud_sync.py

      - name: æäº¤æ›´æ–°
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          if [[ -n "$(git status --porcelain workers.js)" ]]; then
            git add workers.js
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° AssetID"
            git push
          else
            echo "æ— å˜åŠ¨"
          fi
