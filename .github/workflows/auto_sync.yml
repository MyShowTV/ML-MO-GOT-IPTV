name: Auto Sync Longhua Assets

on:
  schedule:
    - cron: '0 19 * * *'  # åŒ—äº¬æ—¶é—´ç¬¬äºŒå¤©å‡Œæ™¨3ç‚¹
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'cloud_sync.py'

env:
  PYTHON_VERSION: '3.9'
  CLASH_VERSION: 'v1.19.0'  # æ›´æ–°ä¸ºæœ€æ–°ç‰ˆæœ¬

jobs:
  sync-longhua:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ§© Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq wget curl unzip
          pip install --upgrade pip
          pip install selenium==4.9.1 requests==2.31.0

      - name: ğŸš€ Setup Clash Proxy (ä¿®å¤ç‰ˆ)
        id: setup-proxy
        run: |
          echo "è®¾ç½® Clash ä»£ç†..."
          
          # 1. ä¸‹è½½ Clashï¼ˆå¤šç‰ˆæœ¬å°è¯•ï¼‰
          echo "æ­£åœ¨ä¸‹è½½ Clash æ ¸å¿ƒ..."
          CLASH_DOWNLOADED=false
          
          # å°è¯•å¤šä¸ªç‰ˆæœ¬
          for version in "v1.19.0" "v1.18.5" "v1.18.0" "v1.17.0"; do
            echo "å°è¯•ä¸‹è½½ç‰ˆæœ¬: $version"
            if wget -q --timeout=30 "https://github.com/Dreamacro/clash/releases/download/${version}/clash-linux-amd64-${version}.gz"; then
              echo "âœ… æˆåŠŸä¸‹è½½ Clash $version"
              CLASH_VERSION=$version
              CLASH_DOWNLOADED=true
              break
            else
              echo "âŒ ç‰ˆæœ¬ $version ä¸‹è½½å¤±è´¥"
            fi
          done
          
          if [ "$CLASH_DOWNLOADED" = false ]; then
            echo "å°è¯•ä½¿ç”¨å¤‡ç”¨ä¸‹è½½æº..."
            wget -q "https://release.dreamacro.workers.dev/latest/clash-linux-amd64-latest.gz"
            if [ -f "clash-linux-amd64-latest.gz" ]; then
              echo "âœ… ä»å¤‡ç”¨æºä¸‹è½½æˆåŠŸ"
              mv clash-linux-amd64-latest.gz clash-linux-amd64-v1.19.0.gz
              CLASH_VERSION="v1.19.0"
              CLASH_DOWNLOADED=true
            fi
          fi
          
          if [ "$CLASH_DOWNLOADED" = false ]; then
            echo "âŒ Clash ä¸‹è½½å¤±è´¥ï¼Œå·¥ä½œæµç»ˆæ­¢"
            exit 1
          fi
          
          # 2. è§£å‹å’Œè®¾ç½®
          gunzip -f "clash-linux-amd64-${CLASH_VERSION}.gz"
          mv "clash-linux-amd64-${CLASH_VERSION}" clash
          chmod +x clash
          
          # 3. åˆ›å»ºé…ç½®æ–‡ä»¶
          echo "åˆ›å»ºä»£ç†é…ç½®æ–‡ä»¶..."
          cat > clash_config.yaml <<'EOF'
          mixed-port: 7890
          allow-lan: false
          mode: global
          log-level: info
          
          proxies:
            - name: "TW-01"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17001
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
            
            - name: "TW-02"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17002
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
            
            - name: "TW-03"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17003
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
          
          proxy-groups:
            - name: "PROXY"
              type: select
              proxies:
                - TW-01
                - TW-02
                - TW-03
          
          rules:
            - MATCH,PROXY
          EOF
          
          # 4. å¯åŠ¨ Clash
          echo "å¯åŠ¨ Clash..."
          ./clash -f clash_config.yaml > clash.log 2>&1 &
          CLASH_PID=$!
          echo $CLASH_PID > clash.pid
          sleep 20
          
          # 5. æµ‹è¯•è¿æ¥
          echo "æµ‹è¯•ä»£ç†è¿æ¥..."
          for i in {1..10}; do
            echo "æµ‹è¯•å°è¯• $i/10..."
            
            if ! ps -p $CLASH_PID > /dev/null 2>&1; then
              echo "âŒ Clash è¿›ç¨‹å·²é€€å‡º"
              echo "=== Clash æ—¥å¿— ==="
              cat clash.log 2>/dev/null || echo "æ— æ—¥å¿—"
              exit 1
            fi
            
            # ä½¿ç”¨æ›´å¯é çš„æµ‹è¯•æ–¹æ³•
            if curl -s --max-time 20 -x http://127.0.0.1:7890 http://httpbin.org/ip > /dev/null 2>&1; then
              echo "âœ… ä»£ç†åŸºæœ¬è¿é€šæ€§æµ‹è¯•é€šè¿‡"
              RESPONSE=$(curl -s --max-time 20 -x http://127.0.0.1:7890 "http://ip-api.com/json/?fields=countryCode,query" || echo '{"countryCode":"ERROR"}')
              COUNTRY=$(echo $RESPONSE | jq -r '.countryCode' 2>/dev/null || echo "ERROR")
              
              if [[ "$COUNTRY" == "TW" ]]; then
                IP=$(echo $RESPONSE | jq -r '.query')
                echo "âœ… ä»£ç†è¿æ¥æˆåŠŸ | IP: $IP | å›½å®¶: å°æ¹¾"
                echo "PROXY_SUCCESS=true" >> $GITHUB_ENV
                break
              else
                echo "âš ï¸ ä»£ç†å·²è¿æ¥ä½†éå°æ¹¾èŠ‚ç‚¹: $COUNTRY"
              fi
            else
              echo "âŒ ä»£ç†è¿æ¥æµ‹è¯•å¤±è´¥"
              sleep 3
            fi
          done
          
          if [[ "$PROXY_SUCCESS" != "true" ]]; then
            echo "âŒ æœ€ç»ˆä»£ç†è¿æ¥å¤±è´¥"
            echo "=== ç½‘ç»œè¯Šæ–­ ==="
            curl -s http://ip-api.com/json/ | jq '.countryCode + " - " + .query' || echo "ç›´è¿å¤±è´¥"
            echo "=== Clash çŠ¶æ€ ==="
            ps aux | grep clash || echo "æ— è¿›ç¨‹"
            echo "=== Clash æ—¥å¿—æœ€å10è¡Œ ==="
            tail -n 10 clash.log 2>/dev/null || echo "æ— æ—¥å¿—"
            exit 1
          fi

      - name: ğŸ”„ Run Sync Script
        env:
          HTTP_PROXY: "http://127.0.0.1:7890"
          HTTPS_PROXY: "http://127.0.0.1:7890"
        run: |
          echo "è®¾ç½®ä»£ç†ç¯å¢ƒ..."
          export http_proxy="http://127.0.0.1:7890"
          export https_proxy="http://127.0.0.1:7890"
          
          echo "å½“å‰ç½‘ç»œç¯å¢ƒ:"
          curl -s http://ip-api.com/json/ | jq '.countryCode + " - " + .query'
          
          echo "å¼€å§‹æ‰§è¡ŒåŒæ­¥è„šæœ¬..."
          python cloud_sync.py
          
          if [[ $? -eq 0 ]]; then
            echo "âœ… åŒæ­¥è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ åŒæ­¥è„šæœ¬æ‰§è¡Œå¤±è´¥"
            exit 1
          fi

      - name: ğŸ“¤ Commit Updates
        if: success()
        run: |
          echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ JSON ç»“æœæ–‡ä»¶
          if ls longhua_assets_*.json 1> /dev/null 2>&1; then
            echo "å‘ç°æ–°çš„ AssetID æ–‡ä»¶"
            git add longhua_assets_*.json
          fi
          
          # æ£€æŸ¥ workers.js æ˜¯å¦è¢«æ›´æ–°
          if [[ -n $(git diff --name-only HEAD workers.js 2>/dev/null) ]]; then
            echo "workers.js å·²è¢«æ›´æ–°"
            git add workers.js
          fi
          
          if [[ -n $(git status --porcelain) ]]; then
            git commit -m "ğŸ”„ Auto Sync Longhua Assets [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push
            echo "ğŸ“¤ å·²æäº¤æ›´æ–°"
          else
            echo "ğŸ“­ æ²¡æœ‰éœ€è¦æ›´æ–°çš„å†…å®¹"
          fi

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "æ¸…ç†è¿›ç¨‹..."
          if [ -f clash.pid ]; then
            kill -9 $(cat clash.pid) 2>/dev/null || true
            rm -f clash.pid
          fi
          pkill -f clash 2>/dev/null || true
          echo "å·¥ä½œæµæ‰§è¡Œå®Œæˆ"

      - name: ğŸ“Š Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ github.run_id }}
          path: |
            clash.log
            sync.log
          retention-days: 3
