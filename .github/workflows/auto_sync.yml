name: Auto Sync Longhua Assets

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨3ç‚¹è¿è¡Œï¼ˆUTCæ—¶é—´ï¼‰
    - cron: '0 19 * * *'  # åŒ—äº¬æ—¶é—´ç¬¬äºŒå¤©å‡Œæ™¨3ç‚¹
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]
    paths:
      - 'cloud_sync.py'

env:
  PYTHON_VERSION: '3.9'
  CLASH_VERSION: 'v1.19.0'

jobs:
  sync-longhua:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ§© Checkout Code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          persist-credentials: true

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq wget curl unzip
          pip install --upgrade pip
          pip install selenium==4.9.1 requests==2.31.0

      - name: ğŸš€ Setup Clash Proxy
        run: |
          echo "è®¾ç½® Clash ä»£ç†..."
          echo "æ­£åœ¨ä¸‹è½½ Clash æ ¸å¿ƒ..."
          
          # å°è¯•å¤šä¸ªç‰ˆæœ¬ï¼ˆé€‚åº”æ–°çš„å‘½åè§„åˆ™ï¼‰
          CLASH_VERSIONS=("v1.19.0" "v1.18.5" "v1.18.0" "v1.17.0")
          DOWNLOAD_SUCCESS=false
          
          for CLASH_VER in "${CLASH_VERSIONS[@]}"; do
            echo "å°è¯•ä¸‹è½½ç‰ˆæœ¬: $CLASH_VER"
            
            # å°è¯•å®˜æ–¹ä¸‹è½½é“¾æ¥
            if wget -q "https://github.com/Dreamacro/clash/releases/download/$CLASH_VER/clash-linux-amd64-$CLASH_VER.gz"; then
              echo "âœ… ä¸‹è½½æˆåŠŸ: $CLASH_VER"
              gunzip "clash-linux-amd64-$CLASH_VER.gz"
              mv "clash-linux-amd64-$CLASH_VER" clash
              chmod +x clash
              DOWNLOAD_SUCCESS=true
              echo "Clash ç‰ˆæœ¬: $CLASH_VER"
              break
            else
              echo "âŒ ç‰ˆæœ¬ $CLASH_VER ä¸‹è½½å¤±è´¥"
            fi
          done
          
          # å¦‚æœå®˜æ–¹ä¸‹è½½éƒ½å¤±è´¥ï¼Œå°è¯•å¤‡ç”¨é“¾æ¥
          if [ "$DOWNLOAD_SUCCESS" = false ]; then
            echo "å°è¯•ä½¿ç”¨å¤‡ç”¨ä¸‹è½½æº..."
            
            # æ–¹æ³•1: å°è¯•ç›´æ¥ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
            wget -q https://github.com/Dreamacro/clash/releases/latest/download/clash-linux-amd64-v3.gz
            if [ $? -eq 0 ]; then
              gunzip clash-linux-amd64-v3.gz
              mv clash-linux-amd64-v3 clash
              chmod +x clash
              echo "âœ… ä½¿ç”¨å¤‡ç”¨é“¾æ¥ä¸‹è½½æˆåŠŸ"
              DOWNLOAD_SUCCESS=true
            else
              # æ–¹æ³•2: ä½¿ç”¨ MIHOMO (Clash Meta) ä½œä¸ºæ›¿ä»£
              echo "å°è¯•ä¸‹è½½ MIHOMO (Clash Meta)..."
              wget -q https://github.com/MetaCubeX/mihomo/releases/latest/download/mihomo-linux-amd64-v1.18.9.gz
              if [ $? -eq 0 ]; then
                gunzip mihomo-linux-amd64-v1.18.9.gz
                mv mihomo-linux-amd64-v1.18.9 clash
                chmod +x clash
                echo "âœ… ä½¿ç”¨ MIHOMO æ›¿ä»£æˆåŠŸ"
                DOWNLOAD_SUCCESS=true
              fi
            fi
          fi
          
          if [ "$DOWNLOAD_SUCCESS" = false ]; then
            echo "âŒ æ‰€æœ‰ä¸‹è½½å°è¯•éƒ½å¤±è´¥äº†"
            echo "è·³è¿‡ä»£ç†è®¾ç½®ï¼Œç›´æ¥å°è¯•è®¿é—®..."
            echo "NO_PROXY=true" >> $GITHUB_ENV
            exit 0
          fi
          
          # åˆ›å»ºä»£ç†é…ç½®æ–‡ä»¶ï¼ˆå°æ¹¾èŠ‚ç‚¹ï¼‰
          echo "åˆ›å»º Clash é…ç½®æ–‡ä»¶..."
          cat > clash_config.yaml <<'EOF'
          mixed-port: 7890
          allow-lan: false
          mode: global
          log-level: info
          
          proxies:
            - name: "TW-01"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17001
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
            
            - name: "TW-02"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17002
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
            
            - name: "TW-03"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17003
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
          
          proxy-groups:
            - name: "PROXY"
              type: select
              proxies:
                - TW-01
                - TW-02
                - TW-03
          
          rules:
            - MATCH,PROXY
          EOF
          
          # å¯åŠ¨ Clash
          echo "å¯åŠ¨ Clash ä»£ç†..."
          ./clash -f clash_config.yaml > clash.log 2>&1 &
          CLASH_PID=$!
          echo "CLASH_PID=$CLASH_PID" >> $GITHUB_ENV
          sleep 10
          
          # éªŒè¯ä»£ç†è¿æ¥
          echo "æµ‹è¯•ä»£ç†è¿æ¥..."
          PROXY_SUCCESS=false
          for i in {1..5}; do
            echo "å°è¯• $i..."
            RESPONSE=$(curl -s --max-time 10 -x http://127.0.0.1:7890 "http://ip-api.com/json/?fields=countryCode,query" || echo '{"countryCode":"ERROR"}')
            COUNTRY=$(echo $RESPONSE | jq -r '.countryCode' 2>/dev/null || echo "ERROR")
            
            if [[ "$COUNTRY" == "TW" ]]; then
              IP=$(echo $RESPONSE | jq -r '.query')
              echo "âœ… ä»£ç†è¿æ¥æˆåŠŸ | IP: $IP | å›½å®¶: å°æ¹¾"
              PROXY_SUCCESS=true
              echo "PROXY_SUCCESS=true" >> $GITHUB_ENV
              break
            elif [[ "$COUNTRY" != "ERROR" ]]; then
              echo "å°è¯• $i: å½“å‰ IP å›½å®¶: $COUNTRY"
            fi
            sleep 3
          done
          
          if [ "$PROXY_SUCCESS" = false ]; then
            echo "âš ï¸ ä»£ç†è¿æ¥æµ‹è¯•æœªé€šè¿‡å°æ¹¾ IP"
            echo "PROXY_SUCCESS=false" >> $GITHUB_ENV
          fi

      - name: ğŸ”„ Run Sync Script
        run: |
          echo "è®¾ç½®ä»£ç†ç¯å¢ƒ..."
          
          # æ£€æŸ¥ä»£ç†æ˜¯å¦å¯ç”¨
          if [ -n "$CLASH_PID" ] && [ "$PROXY_SUCCESS" = "true" ]; then
            export http_proxy="http://127.0.0.1:7890"
            export https_proxy="http://127.0.0.1:7890"
            export HTTP_PROXY="http://127.0.0.1:7890"
            export HTTPS_PROXY="http://127.0.0.1:7890"
            echo "ä½¿ç”¨ä»£ç†: http://127.0.0.1:7890"
            
            # éªŒè¯ä»£ç†è¿æ¥
            echo "éªŒè¯ç½‘ç»œç¯å¢ƒ..."
            RESPONSE=$(curl -s http://ip-api.com/json/ || echo '{"status":"fail"}')
            echo "å½“å‰ç½‘ç»œ: $RESPONSE"
          else
            echo "âš ï¸ æ— ä»£ç†æ¨¡å¼è¿è¡Œ"
            echo "æ³¨æ„ï¼šå¯èƒ½éœ€è¦å°æ¹¾ IP æ‰èƒ½è®¿é—®é¾™åç½‘ç«™"
          fi
          
          echo "å¼€å§‹æ‰§è¡ŒåŒæ­¥è„šæœ¬..."
          python cloud_sync.py
          
          SYNC_EXIT_CODE=$?
          if [[ $SYNC_EXIT_CODE -eq 0 ]]; then
            echo "âœ… åŒæ­¥è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          else
            echo "âŒ åŒæ­¥è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼Œé€€å‡ºç : $SYNC_EXIT_CODE"
            exit $SYNC_EXIT_CODE
          fi

      - name: ğŸ“¤ Commit Updates
        if: success()
        run: |
          echo "=== æ¸…ç†ä¸´æ—¶æ–‡ä»¶ ==="
          rm -f v2ray v2ray.zip clash clash_config.yaml clash.log 2>/dev/null || true
          
          echo "=== æ£€æŸ¥æ–‡ä»¶å˜æ›´ ==="
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ¸…ç†ä¸éœ€è¦çš„ä¸´æ—¶æ–‡ä»¶
          echo "æ¸…ç†å·¥ä½œç›®å½•..."
          rm -f *.tmp *.temp *.bak 2>/dev/null || true
          
          # åªå¤„ç†æˆ‘ä»¬å…³å¿ƒçš„æ–‡ä»¶
          HAS_CHANGES=false
          
          # 1. æ£€æŸ¥æœ€æ–°çš„ JSON ç»“æœæ–‡ä»¶
          echo "æ£€æŸ¥ JSON æ–‡ä»¶..."
          if ls longhua_assets_*.json 1> /dev/null 2>&1; then
            # åªä¿ç•™æœ€æ–°çš„ä¸€ä¸ª JSON æ–‡ä»¶
            LATEST_JSON=$(ls -t longhua_assets_*.json | head -1)
            echo "å‘ç° AssetID æ–‡ä»¶: $LATEST_JSON"
            
            # åˆ é™¤æ—§çš„ JSON æ–‡ä»¶ï¼ˆä¿ç•™æœ€æ–°çš„ï¼‰
            for json_file in longhua_assets_*.json; do
              if [[ "$json_file" != "$LATEST_JSON" ]]; then
                rm -f "$json_file"
              fi
            done
            
            # æ£€æŸ¥è¿™ä¸ªæ–‡ä»¶æ˜¯å¦å·²è·Ÿè¸ª
            if git ls-files --error-unmatch "$LATEST_JSON" >/dev/null 2>&1; then
              echo "$LATEST_JSON å·²åœ¨ç‰ˆæœ¬æ§åˆ¶ä¸­ï¼Œæ£€æŸ¥å˜æ›´..."
              if ! git diff --quiet -- "$LATEST_JSON"; then
                echo "æ–‡ä»¶æœ‰å˜æ›´ï¼Œæ·»åŠ åˆ°æäº¤"
                git add "$LATEST_JSON"
                HAS_CHANGES=true
              fi
            else
              echo "$LATEST_JSON æ˜¯æ–°æ–‡ä»¶ï¼Œæ·»åŠ åˆ°æäº¤"
              git add "$LATEST_JSON"
              HAS_CHANGES=true
            fi
          fi
          
          # 2. æ£€æŸ¥ workers.js æ˜¯å¦æœ‰å˜æ›´
          echo "æ£€æŸ¥ workers.js..."
          if [[ -f "workers.js" ]]; then
            if git ls-files --error-unmatch "workers.js" >/dev/null 2>&1; then
              if ! git diff --quiet -- "workers.js"; then
                echo "workers.js æœ‰å˜æ›´ï¼Œæ·»åŠ åˆ°æäº¤"
                git add workers.js
                HAS_CHANGES=true
              else
                echo "workers.js æ— å˜æ›´"
              fi
            else
              echo "workers.js æ˜¯æ–°æ–‡ä»¶ï¼Œæ·»åŠ åˆ°æäº¤"
              git add workers.js
              HAS_CHANGES=true
            fi
          fi
          
          # 3. å¤„ç†æ—¥å¿—æ–‡ä»¶ï¼ˆä¸æäº¤ï¼Œåªå¤‡ä»½ï¼‰
          echo "å¤„ç†æ—¥å¿—æ–‡ä»¶..."
          if [[ -f "sync.log" ]]; then
            # å¤‡ä»½æ—¥å¿—æ–‡ä»¶
            BACKUP_NAME="sync_$(date +%Y%m%d_%H%M%S).log"
            mv sync.log "$BACKUP_NAME" 2>/dev/null || true
            echo "æ—¥å¿—å·²å¤‡ä»½ä¸º: $BACKUP_NAME"
          fi
          
          # 4. æäº¤æ›´æ–°
          if [[ "$HAS_CHANGES" == true ]]; then
            echo "æ­£åœ¨æäº¤æ›´æ–°..."
            git commit -m "ğŸ”„ Auto Sync Longhua Assets [$(date +'%Y-%m-%d %H:%M:%S')]"
            git push
            echo "âœ… æ›´æ–°å·²æäº¤"
          else
            echo "ğŸ“­ æ²¡æœ‰æ£€æµ‹åˆ°éœ€è¦æäº¤çš„å˜æ›´"
          fi
          
          # 5. æœ€ç»ˆæ¸…ç†
          echo "æœ€ç»ˆæ¸…ç†..."
          rm -f longhua_assets_*.json 2>/dev/null || true
          rm -f sync_*.log 2>/dev/null || true
          rm -f *.log 2>/dev/null || true
          
          echo "=== å®Œæˆ ==="

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "æ¸…ç†è¿›ç¨‹..."
          # åœæ­¢ Clash è¿›ç¨‹
          if [ -n "$CLASH_PID" ]; then
            echo "åœæ­¢ Clash è¿›ç¨‹: $CLASH_PID"
            kill $CLASH_PID 2>/dev/null || true
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f clash clash_config.yaml clash.log v2ray v2ray.zip 2>/dev/null || true
          rm -f *.tmp *.temp *.bak 2>/dev/null || true
          
          echo "å·¥ä½œæµæ‰§è¡Œå®Œæˆ"

      - name: ğŸ“Š Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ github.run_id }}
          path: |
            clash.log
            sync.log
          retention-days: 3
