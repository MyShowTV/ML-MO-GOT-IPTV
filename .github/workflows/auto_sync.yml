name: è‡ªåŠ¨åŒæ­¥ AssetID

on:
  schedule:
    - cron: '0 0,12 * * *'
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install selenium webdriver-manager
          sudo apt-get update
          sudo apt-get install -y shadowsocks-libev

      - name: å¯åŠ¨ Shadowsocks ä»£ç†
        run: |
          # æ ¹æ®ä½ çš„ config.json å¯¹é½å‚æ•°ï¼š
          # server: 154.223.20.190
          # port: 8388
          # method: aes-256-gcm
          ss-local -s 154.223.20.190 -p 8388 -k "${{ secrets.SS_PASSWORD }}" -m aes-256-gcm -l 10808 -v &
          
          echo "ç­‰å¾…ä»£ç†å¯åŠ¨å¹¶æµ‹è¯•å°æ¹¾ IP..."
          sleep 5
          
          # æµ‹è¯•ä»£ç†æ˜¯å¦é€šç•…
          if curl -x socks5://127.0.0.1:10808 -I https://www.google.com --connect-timeout 10; then
            echo "âœ… ä»£ç†è¿æ¥æˆåŠŸï¼"
          else
            echo "âŒ ä»£ç†è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ VPS é˜²ç«å¢™ï¼ˆå®‰å…¨ç»„ï¼‰æ˜¯å¦æ”¾è¡Œäº† 8388 ç«¯å£çš„ TCP æµé‡"
            exit 1
          fi

      - name: è¿è¡ŒåŒæ­¥è„šæœ¬
        env:
          HTTPS_PROXY: http://127.0.0.1:10808
          HTTP_PROXY: http://127.0.0.1:10808
          NO_PROXY: localhost,127.0.0.1
        run: python cloud_sync.py

      - name: æäº¤æ›´æ–°
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          if [[ -n "$(git status --porcelain workers.js)" ]]; then
            git add workers.js
            git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–° AssetID"
            git push
          else
            echo "æ— å˜åŠ¨"
          fi
