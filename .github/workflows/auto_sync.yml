name: Auto Sync Longhua Assets

on:
  schedule:
    - cron: '0 19 * * *'   # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨3ç‚¹è¿è¡Œ
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'cloud_sync.py'

env:
  PYTHON_VERSION: '3.9'
  MIHOMO_VERSION: 'v1.18.9'

jobs:
  sync-longhua:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ§© Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ðŸ“¦ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y wget curl jq unzip
          pip install --upgrade pip
          pip install selenium==4.9.1 requests==2.31.0 selenium-wire==5.1.0 chromedriver-autoinstaller blinker==1.7.0

      - name: ðŸš€ Setup Mihomo Proxy (Auto Detect)
        run: |
          echo "=== [é˜¶æ®µ1] ä¸‹è½½ Mihomo å†…æ ¸ ==="
          wget -q "https://github.com/MetaCubeX/mihomo/releases/download/${MIHOMO_VERSION}/mihomo-linux-amd64-${MIHOMO_VERSION}.gz"
          gunzip "mihomo-linux-amd64-${MIHOMO_VERSION}.gz"
          mv "mihomo-linux-amd64-${MIHOMO_VERSION}" mihomo
          chmod +x mihomo
          echo "âœ… ä¸‹è½½å®Œæˆ"

          echo "=== [é˜¶æ®µ2] è‡ªåŠ¨æŽ¢æµ‹å¯ç”¨å°æ¹¾èŠ‚ç‚¹ç«¯å£ ==="
          SUCCESS=false
          for PORT in $(seq 17001 17010); do
            echo "å°è¯•èŠ‚ç‚¹ç«¯å£: $PORT"
            cat > config.yaml <<EOF
mixed-port: 7890
allow-lan: true
mode: global
log-level: info
proxies:
  - name: "TW"
    type: ss
    server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
    port: $PORT
    cipher: aes-256-gcm
    password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
    udp: false
proxy-groups:
  - name: "PROXY"
    type: select
    proxies:
      - TW
rules:
  - MATCH,PROXY
EOF
            ./mihomo -f config.yaml > mihomo.log 2>&1 &
            sleep 12

            IP_INFO=$(curl -s --max-time 8 -x http://127.0.0.1:7890 http://ip-api.com/json/?fields=country,countryCode,query || echo '{"countryCode":"ERROR"}')
            COUNTRY=$(echo "$IP_INFO" | jq -r '.countryCode' 2>/dev/null || echo "ERROR")

            if [[ "$COUNTRY" == "TW" ]]; then
              echo "âœ… å°æ¹¾èŠ‚ç‚¹æˆåŠŸè¿žæŽ¥ï¼š$(echo "$IP_INFO" | jq -r '.query')"
              echo "PROXY_SUCCESS=true" >> $GITHUB_ENV
              echo "MIHOMO_PID=$(pgrep -f mihomo)" >> $GITHUB_ENV
              SUCCESS=true
              break
            else
              echo "âŒ èŠ‚ç‚¹ç«¯å£ $PORT æ— æ³•è¿žæŽ¥å°æ¹¾ï¼Œé‡è¯•ä¸‹ä¸€ä¸ª..."
              pkill -f mihomo
              sleep 3
            fi
          done

          if [[ "$SUCCESS" == false ]]; then
            echo "âŒ æ‰€æœ‰ç«¯å£å‡è¿žæŽ¥å¤±è´¥ï¼Œä½¿ç”¨ç›´è¿žæ¨¡å¼è¿è¡Œ"
            echo "PROXY_SUCCESS=false" >> $GITHUB_ENV
          fi

      - name: ðŸŒ Verify Proxy IP
        if: env.PROXY_SUCCESS == 'true'
        run: |
          echo "=== éªŒè¯ä»£ç†å‡ºå£ ==="
          curl -x http://127.0.0.1:7890 -s http://ip-api.com/json/?fields=country,query | jq

      - name: ðŸ§  Run Sync Script
        run: |
          echo "=== [é˜¶æ®µ5] å¯åŠ¨åŒæ­¥è„šæœ¬ ==="
          if [ "${PROXY_SUCCESS}" == "true" ]; then
            echo "âœ… ä½¿ç”¨ä»£ç†è¿è¡Œ cloud_sync.py ..."
            export http_proxy="http://127.0.0.1:7890"
            export https_proxy="http://127.0.0.1:7890"
            export HTTP_PROXY="http://127.0.0.1:7890"
            export HTTPS_PROXY="http://127.0.0.1:7890"
          else
            echo "âš ï¸ å½“å‰ä¸ºç›´è¿žæ¨¡å¼è¿è¡Œï¼Œå¯èƒ½æ— æ³•è®¿é—®é¾™åŽé¢‘é“"
          fi

          python cloud_sync.py
          EXIT_CODE=$?
          if [[ $EXIT_CODE -ne 0 ]]; then
            echo "âŒ åŒæ­¥è„šæœ¬æ‰§è¡Œå¤±è´¥ï¼ˆé€€å‡ºç  $EXIT_CODEï¼‰"
            exit $EXIT_CODE
          else
            echo "âœ… åŒæ­¥è„šæœ¬æ‰§è¡ŒæˆåŠŸ"
          fi

      - name: ðŸ“¤ Commit Updates
        if: success()
        run: |
          echo "=== æäº¤æ›´æ–° ==="
          git config --local user.name "github-actions[bot]"
          git config --local user.email "github-actions[bot]@users.noreply.github.com"

          if git diff --quiet; then
            echo "ðŸ“­ æ²¡æœ‰æ–‡ä»¶å˜æ›´"
          else
            git add .
            git commit -m "ðŸ”„ Auto Sync Longhua Assets ($(date '+%Y-%m-%d %H:%M:%S'))"
            git push
            echo "âœ… æ›´æ–°å·²æäº¤"
          fi

      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          echo "=== æ¸…ç†è¿›ç¨‹ä¸Žæ–‡ä»¶ ==="
          pkill -f mihomo || true
          rm -f mihomo config.yaml mihomo.log *.tmp *.log 2>/dev/null || true

      - name: ðŸ“Š Upload Logs on Failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: error-logs-${{ github.run_id }}
          path: |
            mihomo.log
            *.json
          retention-days: 3
