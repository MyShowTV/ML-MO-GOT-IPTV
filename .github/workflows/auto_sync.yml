name: ğŸš€ Auto Sync Longhua Assets

on:
  schedule:
    # æ¯å¤©å‡Œæ™¨3ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´ï¼‰è‡ªåŠ¨è¿è¡Œ
    - cron: '0 19 * * *'
  workflow_dispatch:       # æ”¯æŒæ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main, master ]
    paths:
      - 'cloud_sync.py'
      - '.github/workflows/auto_sync.yml'

env:
  PYTHON_VERSION: '3.11'
  CLASH_VERSION: 'v1.18.0'
  MAX_RETRIES: 3
  RETRY_DELAY: 5

jobs:
  sync-longhua:
    runs-on: ubuntu-latest-8core  # ä½¿ç”¨8æ ¸å¿ƒå®ä¾‹åŠ å¿«é€Ÿåº¦
    timeout-minutes: 30  # è®¾ç½®è¶…æ—¶é˜²æ­¢å¡æ­»
    
    steps:
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
          submodules: false
          persist-credentials: true

      - name: ğŸ“¦ Setup Python Environment
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'  # å¯ç”¨pipç¼“å­˜åŠ é€Ÿ
          cache-dependency-path: '**/requirements.txt'

      - name: ğŸ“¥ Install System Dependencies
        run: |
          echo "å®‰è£…ç³»ç»Ÿä¾èµ–..."
          sudo apt-get update -y
          sudo apt-get install -y \
            jq wget curl unzip \
            chromium-chromedriver \
            ca-certificates \
            gnupg lsb-release
          
          # æ¸…ç†APTç¼“å­˜å‡å°‘é•œåƒå¤§å°
          sudo apt-get clean
          sudo rm -rf /var/lib/apt/lists/*

      - name: ğŸ“¦ Install Python Packages
        run: |
          echo "å®‰è£…PythonåŒ…..."
          python -m pip install --upgrade pip setuptools wheel
          
          # æ£€æŸ¥æ˜¯å¦æœ‰requirements.txtï¼Œå¦åˆ™å®‰è£…é»˜è®¤åŒ…
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          else
            pip install \
              selenium==4.19.0 \
              selenium-wire==5.1.0 \
              requests==2.31.0 \
              beautifulsoup4==4.12.3 \
              lxml==5.2.1 \
              python-dotenv==1.0.0 \
              retrying==1.3.4
          fi
          
          # éªŒè¯å®‰è£…
          python -c "import selenium, requests; print(f'âœ… Selenium {selenium.__version__}, Requests {requests.__version__}')"

      - name: ğŸš€ Setup and Test Proxy Connection
        id: proxy-setup
        run: |
          set -e  # ä»»ä½•æ­¥éª¤å¤±è´¥å³åœæ­¢
          
          echo "ğŸ”„ ä¸‹è½½Clashä»£ç†..."
          CLASH_URL="https://github.com/Dreamacro/clash/releases/download/${CLASH_VERSION}/clash-linux-amd64-${CLASH_VERSION}.gz"
          echo "ä¸‹è½½åœ°å€: $CLASH_URL"
          
          # å¸¦é‡è¯•çš„ä¸‹è½½
          for i in $(seq 1 $MAX_RETRIES); do
            if wget -q "$CLASH_URL" -O clash.gz; then
              echo "âœ… ä¸‹è½½æˆåŠŸ (å°è¯• $i)"
              break
            elif [ $i -eq $MAX_RETRIES ]; then
              echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
              exit 1
            else
              echo "âš ï¸ ä¸‹è½½å¤±è´¥ï¼Œ${RETRY_DELAY}ç§’åé‡è¯•..."
              sleep $RETRY_DELAY
            fi
          done
          
          gunzip -f clash.gz || { echo "è§£å‹å¤±è´¥"; exit 1; }
          chmod +x clash
          
          echo "ğŸ“ åˆ›å»ºä»£ç†é…ç½®..."
          cat > clash_config.yaml <<EOF
          mixed-port: 7890
          external-controller: 127.0.0.1:9090
          allow-lan: false
          mode: global
          log-level: info
          ipv6: false
          
          proxies:
            - name: "TW-01"
              type: ss
              server: brtlee3ogRTfxtWt.xf9pzeslxw.sbs
              port: 17001
              cipher: aes-256-gcm
              password: 1d23e3c5-c047-46a0-b7d8-d838aff7ae8d
              udp: false
          
          proxy-groups:
            - name: "PROXY"
              type: select
              proxies:
                - TW-01
          
          rules:
            - MATCH,PROXY
          EOF
          
          echo "ğŸš€ å¯åŠ¨Clashä»£ç†..."
          nohup ./clash -f clash_config.yaml > clash.log 2>&1 &
          CLASH_PID=$!
          echo "Clash PID: $CLASH_PID"
          echo "CLASH_PID=$CLASH_PID" >> $GITHUB_ENV
          
          # ç­‰å¾…ä»£ç†å¯åŠ¨
          echo "â³ ç­‰å¾…ä»£ç†æœåŠ¡å¯åŠ¨..."
          sleep 10
          
          # æ£€æŸ¥è¿›ç¨‹æ˜¯å¦å­˜æ´»
          if ! ps -p $CLASH_PID > /dev/null; then
            echo "âŒ Clashè¿›ç¨‹å·²é€€å‡º"
            cat clash.log 2>/dev/null || echo "æ— æ—¥å¿—æ–‡ä»¶"
            exit 1
          fi
          
          echo "ğŸ” æµ‹è¯•ä»£ç†è¿æ¥..."
          # æµ‹è¯•å¤šä¸ªç«¯ç‚¹ä»¥ç¡®ä¿ä»£ç†ç¨³å®š
          TEST_ENDPOINTS=(
            "http://ip-api.com/json"
            "https://api.ipify.org?format=json"
            "https://ifconfig.me/all.json"
          )
          
          SUCCESS=false
          for endpoint in "${TEST_ENDPOINTS[@]}"; do
            echo "æµ‹è¯•ç«¯ç‚¹: $endpoint"
            RESPONSE=$(curl -s --max-time 15 -x http://127.0.0.1:7890 "$endpoint" || echo '{}')
            
            if echo "$RESPONSE" | grep -q '"countryCode":"TW"\|"country":"Taiwan"\|"Taiwan"'; then
              IP=$(echo "$RESPONSE" | grep -o '"query":"[^"]*"\|"ip":"[^"]*"' | head -1 | cut -d'"' -f4)
              echo "âœ… ä»£ç†æµ‹è¯•æˆåŠŸ | IP: ${IP:-æœªçŸ¥} | å›½å®¶: å°æ¹¾"
              echo "PROXY_IP=${IP:-æœªçŸ¥}" >> $GITHUB_ENV
              SUCCESS=true
              break
            fi
            sleep 2
          done
          
          if [ "$SUCCESS" = false ]; then
            echo "âŒ æ‰€æœ‰ä»£ç†æµ‹è¯•å¤±è´¥"
            echo "ä»£ç†æ—¥å¿—:"
            tail -50 clash.log 2>/dev/null || echo "æ— æ³•è¯»å–æ—¥å¿—"
            kill $CLASH_PID 2>/dev/null || true
            exit 1
          fi

      - name: ğŸ”„ Execute Sync Script
        env:
          HTTP_PROXY: "http://127.0.0.1:7890"
          HTTPS_PROXY: "http://127.0.0.1:7890"
          NO_PROXY: "localhost,127.0.0.1"
          GITHUB_ACTIONS: "true"
        run: |
          echo "âš™ï¸ è®¾ç½®ä»£ç†ç¯å¢ƒå˜é‡..."
          export http_proxy="http://127.0.0.1:7890"
          export https_proxy="http://127.0.0.1:7890"
          export no_proxy="localhost,127.0.0.1"
          
          echo "ğŸŒ ç½‘ç»œç¯å¢ƒéªŒè¯..."
          echo "ä»£ç†IP: ${{ env.PROXY_IP }}"
          curl -s http://ip-api.com/json | jq -r '"å‡ºå£IP: " + .query + " | å›½å®¶: " + .countryCode' || echo "ç½‘ç»œæµ‹è¯•å¤±è´¥"
          
          echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
          ls -la
          
          echo "ğŸš€ å¼€å§‹æ‰§è¡ŒåŒæ­¥è„šæœ¬..."
          START_TIME=$(date +%s)
          
          # æ‰§è¡ŒPythonè„šæœ¬ï¼Œå¸¦è¶…æ—¶å’Œé‡è¯•
          for attempt in $(seq 1 $MAX_RETRIES); do
            echo "å°è¯• $attempt/$MAX_RETRIES"
            
            if timeout 300 python cloud_sync.py 2>&1 | tee sync_output.log; then
              SYNC_EXIT_CODE=${PIPESTATUS[0]}
              
              if [ $SYNC_EXIT_CODE -eq 0 ]; then
                END_TIME=$(date +%s)
                DURATION=$((END_TIME - START_TIME))
                echo "âœ… åŒæ­¥è„šæœ¬æ‰§è¡ŒæˆåŠŸ | è€—æ—¶: ${DURATION}ç§’"
                
                # æ£€æŸ¥æ˜¯å¦ç”Ÿæˆäº†ç»“æœæ–‡ä»¶
                if ls longhua_assets_*.json 1>/dev/null 2>&1; then
                  RESULT_FILE=$(ls -t longhua_assets_*.json | head -1)
                  echo "ğŸ“„ ç»“æœæ–‡ä»¶: $RESULT_FILE"
                  echo "RESULT_FILE=$RESULT_FILE" >> $GITHUB_ENV
                  
                  # ç®€å•åˆ†æç»“æœ
                  SUCCESS_COUNT=$(jq '[.channels[] | select(.key != "è¿™é‡Œå¡«é’¥åŒ™")] | length' "$RESULT_FILE" 2>/dev/null || echo "0")
                  echo "ğŸ¯ æˆåŠŸæŠ“å–é¢‘é“æ•°: $SUCCESS_COUNT"
                  echo "SUCCESS_COUNT=$SUCCESS_COUNT" >> $GITHUB_ENV
                fi
                break
              else
                echo "âš ï¸ åŒæ­¥è„šæœ¬é€€å‡ºç : $SYNC_EXIT_CODE"
              fi
            else
              echo "âš ï¸ åŒæ­¥è„šæœ¬æ‰§è¡Œè¶…æ—¶"
            fi
            
            if [ $attempt -lt $MAX_RETRIES ]; then
              echo "ç­‰å¾… ${RETRY_DELAY}ç§’åé‡è¯•..."
              sleep $RETRY_DELAY
            else
              echo "âŒ è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼ŒåŒæ­¥å¤±è´¥"
              exit 1
            fi
          done

      - name: ğŸ“¤ Commit and Push Updates
        if: success() && env.SUCCESS_COUNT != '0'
        run: |
          echo "ğŸ“ å‡†å¤‡æäº¤æ›´æ–°..."
          
          # é…ç½®Git
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git config --global pull.rebase false
          
          # æ‹‰å–æœ€æ–°æ›´æ”¹é¿å…å†²çª
          echo "æ‹‰å–è¿œç¨‹æœ€æ–°æ›´æ”¹..."
          git pull origin ${{ github.ref_name }} || echo "æ‹‰å–å¤±è´¥ï¼ˆå¯èƒ½æ˜¯é¦–æ¬¡æäº¤ï¼‰"
          
          # æ£€æŸ¥å“ªäº›æ–‡ä»¶éœ€è¦æäº¤
          echo "æ£€æŸ¥å˜æ›´æ–‡ä»¶..."
          CHANGED_FILES=$(git status --porcelain)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "ğŸ“­ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
            exit 0
          fi
          
          echo "æ£€æµ‹åˆ°å˜æ›´çš„æ–‡ä»¶:"
          echo "$CHANGED_FILES"
          
          # æ·»åŠ æ‰€æœ‰å˜æ›´
          git add -A
          
          # ç”Ÿæˆæœ‰æ„ä¹‰çš„æäº¤ä¿¡æ¯
          COMMIT_TIME=$(date +"%Y-%m-%d %H:%M:%S")
          COMMIT_MSG="ğŸ”„ Auto Sync Longhua Assets [$COMMIT_TIME]
          
          æˆåŠŸæ›´æ–° ${{ env.SUCCESS_COUNT }}/7 ä¸ªé¢‘é“
          
          è‡ªåŠ¨åŒæ­¥å®Œæˆ:
          - ä»£ç†IP: ${{ env.PROXY_IP }}
          - ç»“æœæ–‡ä»¶: ${{ env.RESULT_FILE }}
          - å·¥ä½œæµ: ${{ github.run_id }}
          
          This commit was created automatically by GitHub Actions."
          
          echo "æäº¤ä¿¡æ¯:"
          echo "$COMMIT_MSG"
          
          # æäº¤å¹¶æ¨é€
          if git commit -m "$COMMIT_MSG"; then
            echo "âœ… æäº¤æˆåŠŸ"
            
            # å¸¦é‡è¯•çš„æ¨é€
            for i in $(seq 1 3); do
              if git push origin ${{ github.ref_name }}; then
                echo "âœ… æ¨é€æˆåŠŸ (å°è¯• $i)"
                echo "ğŸ”„ åŒæ­¥å®Œæˆï¼å˜æ›´å·²æäº¤åˆ°ä»“åº“ã€‚"
                break
              else
                echo "âš ï¸ æ¨é€å¤±è´¥ (å°è¯• $i)"
                if [ $i -lt 3 ]; then
                  echo "ç­‰å¾…5ç§’åé‡è¯•..."
                  sleep 5
                  git pull origin ${{ github.ref_name }} --rebase
                else
                  echo "âŒ æ¨é€å¤±è´¥ï¼Œè¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°"
                  exit 1
                fi
              fi
            done
          else
            echo "âŒ æäº¤å¤±è´¥"
            exit 1
          fi

      - name: ğŸ“Š Upload Artifacts on Failure
        if: failure() && steps.proxy-setup.outcome == 'success'
        uses: actions/upload-artifact@v4
        with:
          name: debug-artifacts-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            clash.log
            sync_output.log
            longhua_assets_*.json
            workers.js
            workers.js.backup.*
          retention-days: 7
          if-no-files-found: warn
          compression-level: 9

      - name: ğŸ“‹ Upload Summary Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: workflow-summary-${{ github.run_id }}
          path: |
            sync_output.log
            longhua_assets_*.json
          retention-days: 14
          if-no-files-found: ignore

      - name: ğŸ§¹ Cleanup Resources
        if: always()
        run: |
          echo "ğŸ§¹ æ¸…ç†èµ„æº..."
          
          # åœæ­¢Clashä»£ç†
          if [ -n "$CLASH_PID" ] && ps -p $CLASH_PID > /dev/null; then
            echo "åœæ­¢Clashè¿›ç¨‹ (PID: $CLASH_PID)"
            kill $CLASH_PID 2>/dev/null || true
            sleep 2
          fi
          
          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          echo "æ¸…ç†ä¸´æ—¶æ–‡ä»¶..."
          rm -f clash clash.gz clash_config.yaml 2>/dev/null || true
          
          # æ˜¾ç¤ºç£ç›˜ä½¿ç”¨æƒ…å†µ
          echo "ç£ç›˜ä½¿ç”¨æƒ…å†µ:"
          df -h . | head -2
          
          echo "æ¸…ç†å®Œæˆ"

      - name: ğŸ“ˆ Workflow Status Summary
        if: always()
        run: |
          echo "========================================"
          echo "         å·¥ä½œæµæ‰§è¡Œæ‘˜è¦"
          echo "========================================"
          echo "å·¥ä½œæµID: ${{ github.run_id }}"
          echo "å°è¯•æ¬¡æ•°: ${{ github.run_attempt }}"
          echo "è§¦å‘å™¨: ${{ github.event_name }}"
          echo "åˆ†æ”¯: ${{ github.ref_name }}"
          echo "æäº¤: ${{ github.sha }}"
          echo "æ‰§è¡Œæ—¶é—´: $(date)"
          
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… çŠ¶æ€: æˆåŠŸ"
            echo "æˆåŠŸåŒæ­¥é¢‘é“æ•°: ${{ env.SUCCESS_COUNT }}/7"
            echo "ç»“æœæ–‡ä»¶: ${{ env.RESULT_FILE }}"
            echo "ä»£ç†IP: ${{ env.PROXY_IP }}"
          else
            echo "âŒ çŠ¶æ€: å¤±è´¥"
            echo "è¯·æŸ¥çœ‹é”™è¯¯æ—¥å¿—å’Œä¸Šä¼ çš„è°ƒè¯•æ–‡ä»¶"
          fi
          
          echo "========================================"
